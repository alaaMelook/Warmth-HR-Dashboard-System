<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll - HR System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <span>üë• HR System</span>
            </div>

            <nav class="nav">
                <a href="{{ url_for('admin_dashboard') }}">
                    <span class="icon">üìä</span>
                    Dashboard
                </a>
                <a href="{{ url_for('admin_employees') }}">
                    <span class="icon">üë•</span>
                    Employees
                </a>
                <a href="{{ url_for('admin_user_import') }}">
                    <span class="icon">üì•</span>
                    User Import
                </a>
                <a href="{{ url_for('admin_attendance') }}">
                    <span class="icon">üìÖ</span>
                    Attendance
                </a>
                <a href="{{ url_for('admin_leaves') }}">
                    <span class="icon">üìÑ</span>
                    Leaves
                </a>
                <a href="{{ url_for('admin_payroll') }}" class="active">
                    <span class="icon">üí∞</span>
                    Payroll
                </a>
                <a href="{{ url_for('admin_announcements') }}">
                    <span class="icon">üì¢</span>
                    Announcements
                </a>
                <a href="{{ url_for('logout') }}">
                    <span class="icon">üö™</span>
                    Logout
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="avatar">AD</div>
                <div style="flex:1; min-width:0;">
                    <div style="font-weight:600; font-size:14px; color:#6e625a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        {{ session.get('user_name', 'Admin') }}
                    </div>
                    <div style="font-size:11px; color:#9b8f86;">Administrator</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <div class="header-hero">
                <h1>Payroll</h1>
                <p>Manage payroll and compensation.</p>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        {% if category == 'success' %}
                            <!-- Success Alert (Auto-hide after 3 seconds) -->
                            <div id="successAlert" class="alert-success" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; min-width:300px; box-shadow:0 4px 12px rgba(0,0,0,0.15); animation:slideDown 0.3s ease;">
                                {{ message }}
                            </div>
                        {% elif category == 'danger' or category == 'error' %}
                            <!-- Error Alert (Auto-hide after 3 seconds) -->
                            <div id="errorAlert" class="alert-error" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; min-width:300px; box-shadow:0 4px 12px rgba(0,0,0,0.15); animation:slideDown 0.3s ease;">
                                {{ message }}
                            </div>
                        {% elif category == 'warning' %}
                            <!-- Warning Alert (Auto-hide after 3 seconds) -->
                            <div id="warningAlert" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; min-width:300px; background:#fff6cc; border:1px solid #f2e6a2; color:#9b7e00; padding:12px 14px; border-radius:14px; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.15); animation:slideDown 0.3s ease;">
                                {{ message }}
                            </div>
                        {% else %}
                            <!-- Info Alert (Auto-hide after 3 seconds) -->
                            <div id="infoAlert" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; min-width:300px; background:#e8f4ff; border:1px solid #b3d9ff; color:#0056b3; padding:12px 14px; border-radius:14px; font-weight:700; box-shadow:0 4px 12px rgba(0,0,0,0.15); animation:slideDown 0.3s ease;">
                                {{ message }}
                            </div>
                        {% endif %}
                    {% endfor %}
                    <script>
                        setTimeout(function() {
                            const successAlert = document.getElementById('successAlert');
                            const errorAlert = document.getElementById('errorAlert');
                            const warningAlert = document.getElementById('warningAlert');
                            const infoAlert = document.getElementById('infoAlert');
                            
                            [successAlert, errorAlert, warningAlert, infoAlert].forEach(alert => {
                                if (alert) {
                                    alert.style.animation = 'fadeOut 0.3s ease';
                                    setTimeout(() => alert.remove(), 300);
                                }
                            });
                        }, 3000);
                    </script>
                    <style>
                        @keyframes fadeOut {
                            from { opacity: 1; transform: translateX(-50%) translateY(0); }
                            to { opacity: 0; transform: translateX(-50%) translateY(-10px); }
                        }
                    </style>
                {% endif %}
            {% endwith %}

            <!-- Statistics Cards -->
            <div class="grid-4">
                <div class="card pad kpi">
                    <div class="kpi-top">
                        <label>Total Payroll (All Records)</label>
                        <div class="badge-icon">$</div>
                    </div>
                    <div class="value">${{ "{:,.0f}".format(stats.total_payroll) }}</div>
                    <div class="sub success">Current Month: ${{ "{:,.0f}".format(stats.current_month_payroll) }}</div>
                </div>

                <div class="card pad kpi">
                    <div class="kpi-top">
                        <label>Pay Period</label>
                        <div class="badge-icon">üìÖ</div>
                    </div>
                    <div class="value" style="font-size: 20px;">{{ stats.pay_period }}</div>
                    <div class="sub">Next: {{ stats.next_period }}</div>
                </div>

                <div class="card pad kpi">
                    <div class="kpi-top">
                        <label>Processed</label>
                        <div class="badge-icon">‚úì</div>
                    </div>
                    <div class="value">{{ stats.processed }}</div>
                    <div class="sub success">All payments completed</div>
                </div>

                <div class="card pad kpi">
                    <div class="kpi-top">
                        <label>Pending</label>
                        <div class="badge-icon">‚è±</div>
                    </div>
                    <div class="value">{{ stats.pending }}</div>
                    <div class="sub warning">Awaiting approval</div>
                </div>
            </div>

            <!-- Action Buttons Row -->
            <div class="payroll-actions">
                <h2>Employee Payroll Management</h2>
                <div class="payroll-buttons">
                    <a href="{{ url_for('export_payroll_csv') }}" class="btn-export">
                        <span>‚¨á</span> Export Report
                    </a>
                </div>
            </div>

            <!-- Payroll Table Section -->
            <div class="card">

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Role</th>
                                <th>Pay Date</th>
                                <th>Base Salary</th>
                                <th>Bonus</th>
                                <th>Deductions</th>
                                <th>Net Pay</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="avatar">{{ employee.first_name[0] }}{{ employee.last_name[0] }}</div>
                                        <span>{{ employee.first_name }} {{ employee.last_name }}</span>
                                    </div>
                                </td>
                                <td>{{ employee.role or 'N/A' }}</td>
                                <td style="font-weight: 500; color: #8a7f76;">{{ employee.pay_date }}</td>
                                <td style="font-weight: 500;">${{ "{:,.0f}".format(employee.base_salary) }}</td>
                                <td style="color: #27ae60; font-weight: 500;">${{ "{:,.0f}".format(employee.bonus) }}</td>
                                <td style="color: #e74c3c; font-weight: 500;">${{ "{:,.0f}".format(employee.deductions) }}</td>
                                <td style="font-weight: 600;">${{ "{:,.0f}".format(employee.net_pay) }}</td>
                                <td>
                                    <span class="pill {{ 'success' if employee.status.lower() == 'paid' else 'warning' }}" style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                        {{ employee.status }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn-edit" onclick="openEditModal({{ employee.employee_id }}, '{{ employee.first_name }} {{ employee.last_name }}', {{ employee.base_salary|default(0) }}, {{ employee.bonus|default(0) }}, {{ employee.deductions|default(0) }}, '{{ employee.status }}')" title="Edit Salary">
                                        ‚úèÔ∏è
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="payroll-summary">
                    <div class="payroll-count">
                        Showing {{ employees|length }} payroll record{{ 's' if employees|length != 1 else '' }} (All History)
                    </div>
                    <div class="payroll-totals">
                        <div class="payroll-total-item">
                            <div class="payroll-total-label">Total Base Salary</div>
                            <div class="payroll-total-value">${{ "{:,.0f}".format(totals.total_base_salary) }}</div>
                        </div>
                        <div class="payroll-total-item">
                            <div class="payroll-total-label">Total Bonuses</div>
                            <div class="payroll-total-value positive">${{ "{:,.0f}".format(totals.total_bonuses) }}</div>
                        </div>
                        <div class="payroll-total-item">
                            <div class="payroll-total-label">Total Deductions</div>
                            <div class="payroll-total-value negative">${{ "{:,.0f}".format(totals.total_deductions) }}</div>
                        </div>
                        <div class="payroll-total-item">
                            <div class="payroll-total-label">Total Net Pay</div>
                            <div class="payroll-total-value">${{ "{:,.0f}".format(totals.total_net_pay) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Salary Modal -->
    <div id="editSalaryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editSalaryModal')">&times;</span>
            <h2>Edit Employee Salary</h2>
            <form id="editSalaryForm" method="POST" action="{{ url_for('update_employee_salary') }}">
                <input type="hidden" id="edit_employee_id" name="employee_id">
                <div class="form-group">
                    <label>Employee Name</label>
                    <input type="text" id="edit_employee_name" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Base Salary ($)</label>
                    <input type="number" id="edit_base_salary" name="base_salary" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Bonus ($)</label>
                    <input type="number" id="edit_bonus" name="bonus" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Deductions ($)</label>
                    <input type="number" id="edit_deductions" name="deductions" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Payment Status</label>
                    <select id="edit_status" name="status" required>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('editSalaryModal')">Cancel</button>
                    <button type="submit" class="btn-save">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Bonus Modal -->
    <div id="bonusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bonusModal')">&times;</span>
            <h2>Add Bonus</h2>
            <form id="bonusForm" method="POST" action="{{ url_for('add_bonus') }}">
                <input type="hidden" id="bonus_employee_id" name="employee_id">
                <div class="form-group">
                    <label>Employee Name</label>
                    <input type="text" id="bonus_employee_name" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Bonus Amount ($)</label>
                    <input type="number" id="bonus_amount" name="amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Reason</label>
                    <input type="text" id="bonus_reason" name="reason" placeholder="e.g., Performance bonus, Holiday bonus">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('bonusModal')">Cancel</button>
                    <button type="submit" class="btn-save">Add Bonus</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Deduction Modal -->
    <div id="deductionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('deductionModal')">&times;</span>
            <h2>Add Deduction</h2>
            <form id="deductionForm" method="POST" action="{{ url_for('add_deduction') }}">
                <input type="hidden" id="deduction_employee_id" name="employee_id">
                <div class="form-group">
                    <label>Employee Name</label>
                    <input type="text" id="deduction_employee_name" readonly style="background: #f0f0f0;">
                </div>
                <div class="form-group">
                    <label>Deduction Amount ($)</label>
                    <input type="number" id="deduction_amount" name="amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Reason</label>
                    <input type="text" id="deduction_reason" name="reason" placeholder="e.g., Late arrival, Absence">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('deductionModal')">Cancel</button>
                    <button type="submit" class="btn-save">Add Deduction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Transaction Modal (General) -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addTransactionModal')">&times;</span>
            <h2>Add Bonus or Deduction</h2>
            <form id="addTransactionForm" method="POST" action="{{ url_for('add_payroll_transaction') }}">
                <div class="form-group">
                    <label>Select Employee</label>
                    <select name="employee_id" required>
                        <option value="">-- Select Employee --</option>
                        {% for emp in all_employees %}
                        <option value="{{ emp.employee_id }}">{{ emp.first_name }} {{ emp.last_name }} - {{ emp.role }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Pay Date (Month)</label>
                    <input type="month" name="pay_month" required value="{{ now.strftime('%Y-%m') }}">
                </div>
                <div class="form-group">
                    <label>Base Salary ($)</label>
                    <input type="number" name="base_salary" required min="0" step="0.01" value="5000">
                </div>
                <div class="form-group">
                    <label>Transaction Type</label>
                    <select name="transaction_type" required>
                        <option value="">-- Select Type --</option>
                        <option value="bonus">Bonus</option>
                        <option value="deduction">Deduction</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" name="amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Reason</label>
                    <input type="text" name="reason" placeholder="Reason for this transaction">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('addTransactionModal')">Cancel</button>
                    <button type="submit" class="btn-save">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Modal Management Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function openEditModal(employeeId, employeeName, baseSalary, bonus, deductions, status) {
            document.getElementById('edit_employee_id').value = employeeId;
            document.getElementById('edit_employee_name').value = employeeName;
            document.getElementById('edit_base_salary').value = baseSalary;
            document.getElementById('edit_bonus').value = bonus;
            document.getElementById('edit_deductions').value = deductions;
            document.getElementById('edit_status').value = status || 'pending';
            openModal('editSalaryModal');
        }

        function openBonusModal(employeeId, employeeName) {
            document.getElementById('bonus_employee_id').value = employeeId;
            document.getElementById('bonus_employee_name').value = employeeName;
            document.getElementById('bonus_amount').value = '';
            document.getElementById('bonus_reason').value = '';
            openModal('bonusModal');
        }

        function openDeductionModal(employeeId, employeeName) {
            document.getElementById('deduction_employee_id').value = employeeId;
            document.getElementById('deduction_employee_name').value = employeeName;
            document.getElementById('deduction_amount').value = '';
            document.getElementById('deduction_reason').value = '';
            openModal('deductionModal');
        }

        function openAddTransactionModal() {
            openModal('addTransactionModal');
        }

        // Close flash modal
        function closeFlashModal() {
            const flashModal = document.getElementById('flashModal');
            if (flashModal) {
                flashModal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Logout functionality
        document.querySelector('.sidebar-footer').addEventListener('click', function(e) {
            if(e.target.closest('.sidebar-footer') && confirm('Do you want to logout?')) {
                window.location.href = "{{ url_for('logout') }}";
            }
        });
    </script>
</body>
</html>
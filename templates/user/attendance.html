{% extends "user/base.html" %}
{% set active = "attendance" %}

{% block content %}
  <h1 class="page-title">Attendance History</h1>
  <p class="page-sub">Track your attendance and working hours</p>

  <!-- Check In/Out Card -->
  <div class="card pad" style="margin-bottom:20px;background:linear-gradient(135deg,var(--brown1),var(--brown2));color:#fff;">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;">
      <div>
        <h2 style="font-size:20px;margin:0 0 8px;color:#fff;">Today's Attendance</h2>
        <p style="margin:0;opacity:0.9;font-size:14px;" id="currentTime">Loading...</p>
        <p style="margin:6px 0 0;opacity:0.85;font-size:13px;" id="todayStatus">{{ d.today_status }}</p>
      </div>
      <div id="attendanceButtons" style="display:flex;gap:12px;flex-wrap:wrap;">
        <button id="checkInBtn" class="btn" style="background:#fff;color:var(--brown1);padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.2);{% if d.today_checked_in %}display:none;{% endif %}">
          üü¢ Check In
        </button>
        <button id="checkOutBtn" class="btn" style="background:#fff;color:var(--brown1);padding:12px 24px;border-radius:12px;font-weight:700;cursor:pointer;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.2);{% if not d.today_checked_in or d.today_checked_out %}display:none;{% endif %}">
          üî¥ Check Out
        </button>
      </div>
    </div>
  </div>

  <div class="grid-4" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
    <div class="card pad kpi">
      <div class="kpi-top"><div class="badge-icon">‚úÖ</div></div>
      <label>Present Days</label>
      <div class="value">{{ d.attendance_stats.present }}</div>
    </div>

    <div class="card pad kpi">
      <div class="kpi-top"><div class="badge-icon">‚õî</div></div>
      <label>Absent Days</label>
      <div class="value">{{ d.attendance_stats.absent }}</div>
    </div>

    <div class="card pad kpi">
      <div class="kpi-top"><div class="badge-icon">üü°</div></div>
      <label>Late Arrivals</label>
      <div class="value">{{ d.attendance_stats.late }}</div>
    </div>
  </div>

  <!-- Today's Attendance Details Table -->
  {% if d.today_checked_in %}
  <div class="card" style="margin-top:20px;">
    <div class="card-header">
      <h2 class="page-title" style="margin:0;">Today's Attendance Details</h2>
    </div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Check In Time</th>
            <th>Check Out Time</th>
            <th>Total Hours</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="font-weight:600;">{{ d.today_date }}</td>
            <td>
              <span class="pill success">{{ d.today_check_in }}</span>
            </td>
            <td>
              {% if d.today_check_out %}
                <span class="pill success">{{ d.today_check_out }}</span>
              {% else %}
                <span class="pill warning">Still Working</span>
              {% endif %}
            </td>
            <td>
              {% if d.today_total_hours %}
                <span style="font-weight:700;color:#6f4e3f;">{{ d.today_total_hours }}</span>
              {% else %}
                <span style="color:#9b8f86;">-</span>
              {% endif %}
            </td>
            <td>
              {% if d.today_is_late %}
                <span class="pill warning">‚è∞ Late</span>
              {% else %}
                <span class="pill success">‚úì On Time</span>
              {% endif %}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- Attendance History Table -->
  <div class="card" style="margin-top:20px;">
    <div class="card-header">
      <h2 class="page-title" style="margin:0;">Attendance History</h2>
    </div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Check In</th>
            <th>Check Out</th>
            <th>Total Hours</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% if d.attendance_records %}
            {% for record in d.attendance_records %}
            <tr>
              <td style="font-weight:600;">
                {{ record.attendance_date.strftime('%b %d, %Y') if record.attendance_date else 'N/A' }}
              </td>
              <td>
                {% if record.check_in %}
                  <span class="pill success">
                    {{ (record.check_in|string)[0:5] }}
                  </span>
                {% else %}
                  <span style="color:#9b8f86;">-</span>
                {% endif %}
              </td>
              <td>
                {% if record.check_out %}
                  <span class="pill success">
                    {{ (record.check_out|string)[0:5] }}
                  </span>
                {% else %}
                  <span style="color:#9b8f86;">-</span>
                {% endif %}
              </td>
              <td>
                {% if record.total_hours and record.total_hours != 'N/A' %}
                  <span style="font-weight:700;color:#6f4e3f;">{{ record.total_hours }}</span>
                {% else %}
                  <span style="color:#9b8f86;">-</span>
                {% endif %}
              </td>
              <td>
                {% if record.status == 'present' %}
                  {% if record.check_in and record.check_in|string > '09:00:00' %}
                    <span class="pill warning">‚è∞ Late</span>
                  {% else %}
                    <span class="pill success">‚úì Present</span>
                  {% endif %}
                {% elif record.status == 'absent' %}
                  <span class="pill danger">‚úó Absent</span>
                {% elif record.status == 'leave' %}
                  <span class="pill" style="background:#e9f8ef;border-color:#bfe8cf;color:#2f8c52;">üìÑ Leave</span>
                {% else %}
                  <span class="pill">{{ record.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" style="text-align:center;padding:40px;color:#9b8f86;">
                No attendance records found for this month.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Update current time
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('currentTime').textContent = dateStr + ' - ' + timeStr;
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Check In Button
    const checkInBtn = document.getElementById('checkInBtn');
    if(checkInBtn) {
      checkInBtn.addEventListener('click', async function() {
        if(!confirm('Are you sure you want to check in?')) return;
        
        this.disabled = true;
        this.textContent = '‚è≥ Processing...';
        
        try {
          const response = await fetch('/api/attendance/check-in', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if(data.success) {
            alert('‚úÖ ' + data.message + '\nTime: ' + data.check_in_time);
            document.getElementById('todayStatus').textContent = '‚úì Checked in at ' + data.check_in_time;
            this.style.display = 'none';
            document.getElementById('checkOutBtn').style.display = 'block';
            location.reload();
          } else {
            alert('‚ùå ' + data.message);
            this.disabled = false;
            this.textContent = 'üü¢ Check In';
          }
        } catch(error) {
          console.error('Error:', error);
          alert('‚ùå An error occurred. Please try again.');
          this.disabled = false;
          this.textContent = 'üü¢ Check In';
        }
      });
    }

    // Check Out Button
    const checkOutBtn = document.getElementById('checkOutBtn');
    if(checkOutBtn) {
      checkOutBtn.addEventListener('click', async function() {
        if(!confirm('Are you sure you want to check out?')) return;
        
        this.disabled = true;
        this.textContent = '‚è≥ Processing...';
        
        try {
          const response = await fetch('/api/attendance/check-out', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const data = await response.json();
          
          if(data.success) {
            alert('‚úÖ ' + data.message + '\nTime: ' + data.check_out_time);
            document.getElementById('todayStatus').textContent = '‚úì Checked out at ' + data.check_out_time;
            this.style.display = 'none';
            location.reload();
          } else {
            alert('‚ùå ' + data.message);
            this.disabled = false;
            this.textContent = 'üî¥ Check Out';
          }
        } catch(error) {
          console.error('Error:', error);
          alert('‚ùå An error occurred. Please try again.');
          this.disabled = false;
          this.textContent = 'üî¥ Check Out';
        }
      });
    }
  </script>
{% endblock %}
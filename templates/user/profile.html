{% extends "user/base.html" %}
{% set active = "profile" %}

{% block content %}
  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;">
    <div>
      <h1 class="page-title">My Profile</h1>
      <p class="page-sub">Manage your personal information</p>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn-sm" id="cancelBtn" style="padding:10px 14px;border-radius:12px;display:none;">‚ùå Cancel</button>
      <button class="btn-sm primary" id="editBtn" style="padding:10px 14px;border-radius:12px;">‚úèÔ∏è Edit Profile</button>
    </div>
  </div>

  <!-- Success Message (Fixed at top) -->
  <div id="successMsg" class="alert-success" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; min-width:300px; max-width:500px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
    Profile updated successfully!
  </div>

  <!-- Error Message (Fixed at top) -->
  <div id="errorMsg" class="alert-error" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; min-width:300px; max-width:500px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
    ‚ùå <span id="errorText">Something went wrong!</span>
  </div>

  <form id="profileForm">
    <input type="hidden" name="user_id" value="{{ d.user.user_id }}">
    
    <div class="row-2" style="grid-template-columns: 1.1fr 1.9fr;">
      <div>
        <div class="card pad" style="text-align:center;">
          <div class="avatar" style="width:96px;height:96px;margin:10px auto 12px;font-size:26px;">
            {{ (d.user.first_name[:1] ~ d.user.last_name[:1]).upper() }}
          </div>

          <div style="font-weight:900;color:#6f4e3f;font-size:18px;">{{ d.user.full_name }}</div>
          <div class="page-sub" style="margin:6px 0 12px;">
            {{ d.user.position }}
          </div>

          <div class="card pad" style="box-shadow:none;background:#faf3ec;border:1px solid var(--line);margin-top:10px;">
            <div style="font-size:12px;color:#8a7f76;">Employee ID</div>
            <div style="font-weight:900;color:#6f4e3f;margin-top:4px;">{{ d.user.employee_id }}</div>
          </div>
        </div>

        <div class="card pad" style="margin-top:16px;">
          <div style="font-weight:900;color:#8e6e5e;margin-bottom:14px;font-size:16px;">Quick Stats</div>

          <div style="display:flex;justify-content:space-between;margin:12px 0;padding:8px 0;">
            <div class="time">Tenure</div>
            <div style="font-weight:900;color:#6f4e3f;">{{ d.user.tenure_years }} years</div>
          </div>

          <div style="display:flex;justify-content:space-between;margin:12px 0;padding:8px 0;border-top:1px solid var(--line);">
            <div class="time">Attendance</div>
            <div style="font-weight:900;color:#2f8c52;">{{ d.user.attendance_rate }}%</div>
          </div>

          <div style="display:flex;justify-content:space-between;margin:12px 0;padding:8px 0;border-top:1px solid var(--line);">
            <div class="time">Leaves Taken</div>
            <div style="font-weight:900;color:#6f4e3f;">{{ d.user.leaves_taken }}</div>
          </div>
        </div>
      </div>

      <div>
        <div class="card pad">
          <div style="font-weight:900;color:#8e6e5e;margin-bottom:14px;font-size:16px;">Personal Information</div>

          <div style="display:grid;grid-template-columns:1fr;gap:12px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div>
                <div class="time" style="margin-bottom:6px;">First Name <span style="color:#c54949;">*</span></div>
                <input class="input profile-input" name="first_name" value="{{ d.user.first_name }}" disabled required />
              </div>

              <div>
                <div class="time" style="margin-bottom:6px;">Last Name <span style="color:#c54949;">*</span></div>
                <input class="input profile-input" name="last_name" value="{{ d.user.last_name }}" disabled required />
              </div>
            </div>

            <div>
              <div class="time" style="margin-bottom:6px;">Email Address <span style="color:#c54949;">*</span></div>
              <input class="input profile-input" type="email" name="email" value="{{ d.user.email }}" disabled required />
            </div>

            <div>
              <div class="time" style="margin-bottom:6px;">Phone Number</div>
              <input class="input profile-input" type="tel" name="phone" value="{{ d.user.phone }}" placeholder="+1 (555) 123-4567" disabled />
            </div>

            <div>
              <div class="time" style="margin-bottom:6px;">Address</div>
              <input class="input profile-input" name="address" value="{{ d.user.address }}" placeholder="Enter your address" disabled />
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <div>
                <div class="time" style="margin-bottom:6px;">Department</div>
                <input class="input" value="{{ d.user.department }}" disabled style="background:#f0e8e0;cursor:not-allowed;" />
              </div>

              <div>
                <div class="time" style="margin-bottom:6px;">Position</div>
                <input class="input" value="{{ d.user.position }}" disabled style="background:#f0e8e0;cursor:not-allowed;" />
              </div>
            </div>

            <div>
              <div class="time" style="margin-bottom:6px;">Join Date</div>
              <input class="input" value="{{ d.user.join_date }}" disabled style="background:#f0e8e0;cursor:not-allowed;" />
            </div>
          </div>
        </div>

        <div class="card pad" style="margin-top:16px;">
          <div style="font-weight:900;color:#8e6e5e;margin-bottom:14px;font-size:16px;">Emergency Contact</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <div class="time" style="margin-bottom:6px;">Contact Name</div>
              <input class="input profile-input" name="emergency_name" value="{{ d.user.emergency_name or 'Jane Doe' }}" placeholder="Contact name" disabled />
            </div>

            <div>
              <div class="time" style="margin-bottom:6px;">Relationship</div>
              <input class="input profile-input" name="emergency_relationship" value="{{ d.user.emergency_relationship or 'Spouse' }}" placeholder="Relationship" disabled />
            </div>

            <div style="grid-column:1/-1;">
              <div class="time" style="margin-bottom:6px;">Phone Number</div>
              <input class="input profile-input" type="tel" name="emergency_phone" value="{{ d.user.emergency_phone or '+1 (555) 123-0000' }}" placeholder="+1 (555) 123-4567" disabled />
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <script>
    const editBtn = document.getElementById('editBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const profileForm = document.getElementById('profileForm');
    const profileInputs = document.querySelectorAll('.profile-input');
    const successMsg = document.getElementById('successMsg');
    const errorMsg = document.getElementById('errorMsg');
    const errorText = document.getElementById('errorText');

    let isEditing = false;
    let originalValues = {};

    // Save original values
    profileInputs.forEach(input => {
      originalValues[input.name] = input.value;
    });

    editBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      if (!isEditing) {
        // Enable editing
        isEditing = true;
        profileInputs.forEach(input => {
          input.disabled = false;
          input.style.background = '#fff';
        });
        
        editBtn.innerHTML = 'üíæ Save Changes';
        editBtn.classList.add('btn-save');
        cancelBtn.style.display = 'block';
        
        hideMessages();
      } else {
        // Save changes
        saveProfile();
      }
    });

    cancelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Restore original values
      profileInputs.forEach(input => {
        input.value = originalValues[input.name] || '';
        input.disabled = true;
        input.style.background = '#f7f7f7';
      });
      
      isEditing = false;
      editBtn.innerHTML = '‚úèÔ∏è Edit Profile';
      editBtn.classList.remove('btn-save');
      cancelBtn.style.display = 'none';
      
      hideMessages();
    });

    function saveProfile() {
      const formData = new FormData(profileForm);
      const data = Object.fromEntries(formData.entries());

      // Show loading
      editBtn.innerHTML = '‚è≥ Saving...';
      editBtn.disabled = true;

      fetch('/update_profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          // Update original values
          profileInputs.forEach(input => {
            originalValues[input.name] = input.value;
            input.disabled = true;
            input.style.background = '#f7f7f7';
          });
          
          isEditing = false;
          editBtn.innerHTML = '‚úèÔ∏è Edit Profile';
          editBtn.classList.remove('btn-save');
          cancelBtn.style.display = 'none';
          
          showSuccess('Profile updated successfully!');
          
          // Reload page after 2 seconds to update all data
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          showError(result.message || 'Failed to update profile');
          editBtn.innerHTML = 'üíæ Save Changes';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showError('Connection error. Please try again.');
        editBtn.innerHTML = 'üíæ Save Changes';
      })
      .finally(() => {
        editBtn.disabled = false;
      });
    }

    function showSuccess(message) {
      successMsg.textContent = '‚úÖ ' + message;
      successMsg.style.display = 'block';
      successMsg.style.animation = 'slideDown 0.3s ease-out';
      errorMsg.style.display = 'none';
      
      setTimeout(() => {
        successMsg.style.animation = 'fadeOut 0.5s ease-out forwards';
        setTimeout(() => {
          successMsg.style.display = 'none';
        }, 500);
      }, 3000);
    }

    function showError(message) {
      errorText.textContent = message;
      errorMsg.style.display = 'block';
      errorMsg.style.animation = 'slideDown 0.3s ease-out';
      successMsg.style.display = 'none';
      
      setTimeout(() => {
        errorMsg.style.animation = 'fadeOut 0.5s ease-out forwards';
        setTimeout(() => {
          errorMsg.style.display = 'none';
        }, 500);
      }, 3000);
    }

    function hideMessages() {
      successMsg.style.display = 'none';
      errorMsg.style.display = 'none';
    }
  </script>

  <style>
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
    }
  </style>
{% endblock %}